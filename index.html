<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è‹±è¯­èƒ½åŠ›æµ‹è¯„</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@3/lib/index.css"/>
    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@3/lib/vant.min.js"></script>
    <style>
        body { 
            background-color: #f7f8fa; 
            padding: 15px; 
            font-family: sans-serif; 
            margin: 0;
        }
        .test-container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding-bottom: 30px;
        }
        .question-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .audio-box { 
            background: #667eea; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            color: white;
            transition: background 0.3s;
        }
        .audio-box:hover {
            background: #5568d3;
        }
        .audio-box:active {
            background: #4c5ec4;
        }
        .question-text { 
            font-size: 18px; 
            font-weight: bold; 
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .debug-info { 
            background: #fff3cd; 
            padding: 10px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            font-size: 12px; 
            word-break: break-all;
            border: 1px solid #ffc107;
        }
        .submit-btn {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div id="app" class="test-container">
    <van-nav-bar title="è‹±è¯­èƒ½åŠ›æµ‹è¯„" sticky></van-nav-bar>
    
    <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆä¸Šçº¿åå¯åˆ é™¤æˆ–è®¾ç½®debugModeä¸ºfalseï¼‰ -->
    <div v-if="debugMode && debugInfo" class="debug-info">
        <strong>ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š</strong><br>
        {{ debugInfo }}
    </div>
    
    <div v-if="questions.length > 0">
        <div v-for="(q, index) in questions" :key="index" class="question-card">
            <!-- å¬åŠ›é¢˜ -->
            <div v-if="q.audio_text">
                <div style="color:#969799; font-size:14px; margin-bottom:8px;">
                    ğŸ§ ç¬¬ {{index+1}} é¢˜ï¼šå¬åŠ›ç†è§£
                </div>
                <div class="audio-box" @click="playAudio(q.audio_text)">
                    <van-icon name="volume-o" size="24" style="margin-right:10px;"></van-icon>
                    <span>ç‚¹å‡»æ’­æ”¾éŸ³é¢‘ (è¯·è®¤çœŸå¬)</span>
                </div>
            </div>
            <!-- æ™®é€šé¢˜ -->
            <div v-else class="question-text">
                {{ index + 1 }}. {{ q.question }}
            </div>
            
            <!-- é€‰é¡¹ -->
            <van-radio-group v-model="userAnswers[index]">
                <van-radio 
                    v-for="(opt, i) in q.options" 
                    :key="i" 
                    :name="opt" 
                    style="margin-bottom:12px;">
                    {{ opt }}
                </van-radio>
            </van-radio-group>
        </div>
        
        <van-button 
            type="primary" 
            block 
            round 
            class="submit-btn"
            @click="submitTest">
            æäº¤æµ‹éªŒ
        </van-button>
    </div>
    
    <van-empty 
        v-else 
        description="è¯•å·åŠ è½½ä¸­...è¯·ç¨å€™"
        image="search">
    </van-empty>
</div>

<script>
    const app = Vue.createApp({
        data() { 
            return { 
                questions: [],           // é¢˜ç›®æ•°ç»„
                userAnswers: [],         // ç”¨æˆ·ç­”æ¡ˆæ•°ç»„
                debugMode: false,        // è°ƒè¯•æ¨¡å¼å¼€å…³ï¼ˆä¸Šçº¿åè®¾ä¸ºfalseï¼‰
                debugInfo: ''            // è°ƒè¯•ä¿¡æ¯
            }; 
        },
        created() {
            this.loadQuestions();
        },
        methods: {
            /**
             * åŠ è½½é¢˜ç›®æ•°æ®
             */
            loadQuestions() {
                const urlParams = new URLSearchParams(window.location.search);
                const rawData = urlParams.get('data');
                
                if (!rawData) {
                    this.debugInfo = 'URLä¸­æœªæ‰¾åˆ°dataå‚æ•°';
                    vant.Toast.fail("æœªæ‰¾åˆ°é¢˜ç›®æ•°æ®");
                    return;
                }
                
                try {
                    // ç¬¬ä¸€æ­¥ï¼šURLè§£ç 
                    let text = decodeURIComponent(rawData);
                    this.debugInfo = `åŸå§‹æ•°æ®é•¿åº¦: ${text.length} å­—ç¬¦`;
                    
                    // ç¬¬äºŒæ­¥ï¼šè§£æJSON
                    let parsed = JSON.parse(text);
                    
                    // ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®ä¸åŒçš„æ•°æ®ç»“æ„æå–é¢˜ç›®æ•°ç»„
                    let questionsArray = null;
                    
                    // æƒ…å†µ1: DeepSeek API å®Œæ•´è¿”å›æ ¼å¼
                    // { "output": { "choices": [{ "message": { "content": "[...]" } }] } }
                    if (parsed.output && parsed.output.choices && parsed.output.choices[0]) {
                        const content = parsed.output.choices[0].message.content;
                        // content æ˜¯å­—ç¬¦ä¸²å½¢å¼çš„JSONï¼Œéœ€è¦å†æ¬¡è§£æ
                        questionsArray = JSON.parse(content);
                        this.debugInfo += ' | æ ¼å¼: DeepSeek API';
                    }
                    // æƒ…å†µ2: ç›´æ¥æ˜¯é¢˜ç›®æ•°ç»„ [{ question: ... }, ...]
                    else if (Array.isArray(parsed)) {
                        questionsArray = parsed;
                        this.debugInfo += ' | æ ¼å¼: ç›´æ¥æ•°ç»„';
                    }
                    // æƒ…å†µ3: åŒ…å«questionså­—æ®µ { questions: [...] }
                    else if (parsed.questions && Array.isArray(parsed.questions)) {
                        questionsArray = parsed.questions;
                        this.debugInfo += ' | æ ¼å¼: questionså­—æ®µ';
                    }
                    // æƒ…å†µ4: å…œåº•æ–¹æ¡ˆ - æ­£åˆ™æå–
                    else {
                        const match = text.match(/\[\s*\{.*\}\s*\]/s);
                        if (match) {
                            questionsArray = JSON.parse(match[0]);
                            this.debugInfo += ' | æ ¼å¼: æ­£åˆ™æå–';
                        }
                    }
                    
                    // ç¬¬å››æ­¥ï¼šéªŒè¯å¹¶ä¿å­˜é¢˜ç›®æ•°ç»„
                    if (questionsArray && Array.isArray(questionsArray) && questionsArray.length > 0) {
                        this.questions = questionsArray;
                        this.userAnswers = new Array(this.questions.length).fill('');
                        this.debugInfo += ` | âœ… æˆåŠŸåŠ è½½ ${this.questions.length} é“é¢˜ç›®`;
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        if (this.debugMode) {
                            vant.Toast.success(`åŠ è½½äº†${this.questions.length}é“é¢˜ç›®`);
                        }
                    } else {
                        throw new Error('é¢˜ç›®æ•°ç»„ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    }
                    
                } catch (e) { 
                    console.error('é¢˜ç›®è§£æé”™è¯¯:', e);
                    this.debugInfo = `âŒ è§£æå¤±è´¥: ${e.message}`;
                    vant.Toast.fail("é¢˜ç›®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥"); 
                }
            },
            
            /**
             * æ’­æ”¾å¬åŠ›éŸ³é¢‘
             */
            playAudio(text) { 
                // åœæ­¢å½“å‰æ’­æ”¾
                window.speechSynthesis.cancel(); 
                
                // åˆ›å»ºè¯­éŸ³å¯¹è±¡
                const utterance = new SpeechSynthesisUtterance(text); 
                utterance.lang = 'en-US';    // è‹±è¯­
                utterance.rate = 0.9;        // è¯­é€Ÿç¨æ…¢ï¼Œä¾¿äºç†è§£
                utterance.pitch = 1.0;       // éŸ³è°ƒæ­£å¸¸
                utterance.volume = 1.0;      // éŸ³é‡æœ€å¤§
                
                // æ’­æ”¾è¯­éŸ³
                window.speechSynthesis.speak(utterance);
                
                // æ˜¾ç¤ºæ’­æ”¾æç¤º
                vant.Toast.loading({
                    message: 'æ’­æ”¾ä¸­...',
                    duration: 0,
                    forbidClick: true
                });
                
                // æ’­æ”¾ç»“æŸåå…³é—­æç¤º
                utterance.onend = () => {
                    vant.Toast.clear();
                };
            },
            
            /**
             * æäº¤æµ‹éªŒ
             */
            submitTest() {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªä½œç­”çš„é¢˜ç›®
                const unanswered = this.userAnswers.filter(ans => !ans).length;
                
                if (unanswered > 0) {
                    vant.Dialog.confirm({
                        title: 'æç¤º',
                        message: `è¿˜æœ‰ ${unanswered} é“é¢˜æœªä½œç­”ï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ`,
                    }).then(() => {
                        this.calculateAndSubmit();
                    }).catch(() => {
                        // ç”¨æˆ·å–æ¶ˆ
                    });
                } else {
                    this.calculateAndSubmit();
                }
            },
            
            /**
             * è®¡ç®—åˆ†æ•°å¹¶æäº¤
             */
            calculateAndSubmit() {
                let correct = 0;
                
                // ç»Ÿè®¡æ­£ç¡®ç­”æ¡ˆæ•°
                this.questions.forEach((q, i) => {
                    const userAnswer = (this.userAnswers[i] || "").trim();
                    const correctAnswer = q.answer.trim();
                    
                    // ç­”æ¡ˆåŒ¹é…ï¼šå®Œå…¨ç›¸ç­‰ æˆ– ä»¥æ­£ç¡®ç­”æ¡ˆå¼€å¤´
                    if (userAnswer === correctAnswer || userAnswer.startsWith(correctAnswer)) {
                        correct++;
                    }
                });
                
                // è®¡ç®—åˆ†æ•°
                const score = Math.round((correct / this.questions.length) * 100);
                
                // æ„å»ºé£ä¹¦è¡¨å•æäº¤URL
                const urlParams = new URLSearchParams(window.location.search);
                const studentName = urlParams.get('name') || 'æœªçŸ¥å­¦ç”Ÿ';
                const studentId = urlParams.get('rid') || '';
                
                const submitUrl = `https://ycn7fuexi0uc.feishu.cn/share/base/form/shrcndu6DXhs0BJqVoFvkkndKHe?prefill_å­¦ç”Ÿå§“å=${encodeURIComponent(studentName)}&prefill_æµ‹è¯•åˆ†æ•°=${score}&prefill_å­¦ç”ŸID=${studentId}&hide_æµ‹è¯•åˆ†æ•°=1`;
                
                // æ˜¾ç¤ºå¾—åˆ†æç¤º
                vant.Toast.success({
                    message: `æµ‹è¯•å®Œæˆï¼\nå¾—åˆ†ï¼š${score}åˆ† (${correct}/${this.questions.length})`,
                    duration: 2000
                });
                
                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åˆ†æ•°
                setTimeout(() => {
                    window.location.href = submitUrl;
                }, 2000);
            }
        }
    }).use(vant).mount('#app');
</script>
</body>
</html>
