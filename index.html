<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è‹±è¯­æµ‹è¯„</title>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@3/lib/index.css"/>
    <script src="https://fastly.jsdelivr.net/npm/vue@3"></script>
    <script src="https://fastly.jsdelivr.net/npm/vant@3/lib/vant.min.js"></script>
    <style>
        body { background-color: #f7f8fa; padding: 15px; font-family: sans-serif; }
        .test-container { max-width: 600px; margin: 0 auto; }
        .question-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .audio-box { background: #667eea; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; }
        .question-text { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .submit-btn { margin-top: 20px; margin-bottom: 40px; }
    </style>
</head>
<body>
<div id="app" class="test-container">
    <van-nav-bar title="è‹±è¯­èƒ½åŠ›æµ‹è¯„" sticky></van-nav-bar>
    <div v-if="questions.length > 0">
        <div v-for="(q, index) in questions" :key="index" class="question-card">
            <div v-if="q.audio_text">
                <div style="color:#969799; font-size:14px; margin-bottom:8px;">ğŸ§ ç¬¬ {{index+1}} é¢˜ï¼šå¬åŠ›ç†è§£</div>
                <div class="audio-box" @click="playAudio(q.audio_text)">
                    <van-icon name="volume-o" size="24" style="margin-right:10px;"></van-icon>
                    <span style="font-weight: bold;">ç‚¹å‡»æ’­æ”¾éŸ³é¢‘</span>
                </div>
            </div>
            <div v-else class="question-text">{{ index + 1 }}. {{ q.question }}</div>
            <van-radio-group v-model="userAnswers[index]" @change="recordTime(index)">
                <van-radio v-for="(opt, i) in q.options" :key="i" :name="opt" style="margin-bottom:12px;">{{ opt }}</van-radio>
            </van-radio-group>
        </div>
        <van-button type="primary" block round class="submit-btn" @click="submitTest">æäº¤æµ‹éªŒ</van-button>
    </div>
    <van-empty v-else description="è¯•å·åŠ è½½ä¸­...è‹¥æ— ååº”è¯·æ£€æŸ¥å‚æ•°"></van-empty>
</div>

<script>
    const app = Vue.createApp({
        data() { return { questions: [], userAnswers: [], timeLogs: [], lastTime: Date.now() }; },
        created() {
            const urlParams = new URLSearchParams(window.location.search);
            const rawData = urlParams.get('data');
            if (rawData) {
                try {
                    let text = decodeURIComponent(rawData);
                    // å¼ºåŠ›æ­£åˆ™ï¼šç›´æ¥æŠ“å–æ•°æ®ä¸­çš„é¢˜ç›®æ•°ç»„éƒ¨åˆ†ï¼Œè§£å†³æ‰€æœ‰åŠ è½½ç©ºç™½é—®é¢˜
                    const match = text.match(/\[\s*\{.*\}\s*\]/s);
                    let parsed = match ? JSON.parse(match[0]) : JSON.parse(text);
                    if (parsed.questions) parsed = parsed.questions;
                    this.questions = Array.isArray(parsed) ? parsed : [];
                    this.userAnswers = new Array(this.questions.length).fill('');
                    this.timeLogs = new Array(this.questions.length).fill(0);
                    this.lastTime = Date.now();
                } catch (e) { vant.Toast.fail("é¢˜ç›®è§£æå¤±è´¥"); }
            }
        },
        methods: {
            playAudio(t) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang='en-US'; window.speechSynthesis.speak(u); },
            recordTime(i) { const n = Date.now(); this.timeLogs[i] = Math.floor((n-this.lastTime)/1000); this.lastTime = n; },
            submitTest() {
                let behavior = [];
                let correct = 0;
                this.questions.forEach((q, i) => {
                    const ok = (this.userAnswers[i]||"").startsWith(q.answer) || (this.userAnswers[i] === q.answer);
                    if(ok) correct++;
                    behavior.push(`é¢˜${i+1}:${ok?'å¯¹':'é”™'}(${this.timeLogs[i]||0}s)`);
                });
                const score = Math.round((correct/this.questions.length)*100);
                const urlParams = new URLSearchParams(window.location.search);
                const rid = urlParams.get('rid') || "";
                const name = urlParams.get('name') || "å­¦ç”Ÿ";
                const formUrl = "https://ycn7fuexi0uc.feishu.cn/share/base/form/shrcndu6DXhs0BJqVoFvkkndKHe";
                const submitUrl = `${formUrl}?prefill_å­¦ç”Ÿå§“å=${encodeURIComponent(name)}&prefill_æµ‹è¯•åˆ†æ•°=${score}&prefill_å­¦ç”ŸID=${rid}&prefill_å­¦ä¹ è¡Œä¸ºæ•°æ®=${encodeURIComponent(behavior.join(' | '))}&hide_æµ‹è¯•åˆ†æ•°=1&hide_å­¦ç”ŸID=1&hide_å­¦ä¹ è¡Œä¸ºæ•°æ®=1`;
                window.location.href = submitUrl;
            }
        }
    }).use(vant).mount('#app');
</script>
</body>
</html>
